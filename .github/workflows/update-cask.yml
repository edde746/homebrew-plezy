name: Update Plezy Cask

on:
  schedule:
    # Check for new releases every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (e.g., 1.11.0)"
        required: false
        type: string
      force:
        description: "Force update even if version exists"
        required: false
        type: boolean
        default: false

jobs:
  check-and-update:
    runs-on: macos-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release from upstream
        id: latest_release
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            LATEST_VERSION="${{ inputs.version }}"
            echo "Using manual version: $LATEST_VERSION"
          else
            echo "Fetching latest release from GitHub API..."

            # Check GitHub API status first
            echo "Checking GitHub API status..."
            API_STATUS=$(curl -s -w "HTTPSTATUS:%{http_code}" https://api.github.com/status)
            STATUS_CODE=$(echo "$API_STATUS" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

            if [ "$STATUS_CODE" != "200" ]; then
              echo "Warning: GitHub API status check failed (HTTP $STATUS_CODE)"
            else
              echo "GitHub API is accessible"
            fi

            # Function to make API call with retry logic
            fetch_release_with_retry() {
              local max_attempts=3
              local attempt=1
              local delay=5

              while [ $attempt -le $max_attempts ]; do
                echo "Attempt $attempt of $max_attempts..."

                # Check if GitHub token is available
                if [ -n "$GITHUB_TOKEN" ]; then
                  echo "Using authenticated GitHub API request"
                else
                  echo "Using unauthenticated GitHub API request"
                fi

                # Make API call with better error handling
                if [ -n "$GITHUB_TOKEN" ]; then
                  API_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    https://api.github.com/repos/edde746/plezy/releases/latest)
                else
                  API_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    https://api.github.com/repos/edde746/plezy/releases/latest)
                fi

                HTTP_STATUS=$(echo "$API_RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
                API_BODY=$(echo "$API_RESPONSE" | sed -e 's/HTTPSTATUS:.*//g')

                echo "HTTP Status: $HTTP_STATUS"
                echo "API Response length: ${#API_BODY}"

                if [ "$HTTP_STATUS" = "200" ]; then
                  # Check if response is valid JSON
                  if echo "$API_BODY" | jq . >/dev/null 2>&1; then
                    # Extract tag_name with better error checking
                    LATEST_VERSION=$(echo "$API_BODY" | jq -r '.tag_name // empty')

                    if [ "$LATEST_VERSION" != "null" ] && [ -n "$LATEST_VERSION" ]; then
                      echo "Successfully extracted version: $LATEST_VERSION"
                      return 0
                    else
                      echo "tag_name field was null or empty"
                    fi
                  else
                    echo "Invalid JSON response from GitHub API"
                  fi
                elif [ "$HTTP_STATUS" = "403" ]; then
                  echo "Rate limited by GitHub API (HTTP 403)"
                  # Check for rate limit specific message
                  if echo "$API_BODY" | jq -e '.message' >/dev/null 2>&1; then
                    ERROR_MESSAGE=$(echo "$API_BODY" | jq -r '.message')
                    echo "GitHub API error: $ERROR_MESSAGE"
                  fi
                elif [ "$HTTP_STATUS" = "404" ]; then
                  echo "Repository or releases not found (HTTP 404)"
                  echo "Response: $API_BODY"
                  return 1
                else
                  echo "GitHub API request failed with status: $HTTP_STATUS"
                  echo "Response body: $API_BODY"
                fi

                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting $delay seconds before retry..."
                  sleep $delay
                  delay=$((delay * 2))  # Exponential backoff
                fi

                attempt=$((attempt + 1))
              done

              return 1
            }

            # Try to fetch the release
            if ! fetch_release_with_retry; then
              echo "Failed to get latest version after all retry attempts"
              echo "LATEST_VERSION='$LATEST_VERSION'"
              echo ""
              echo "This could indicate:"
              echo "- No releases found in the repository"
              echo "- All releases are drafts or pre-releases"
              echo "- GitHub API rate limiting"
              echo "- Network connectivity issues"
              echo "- Repository access issues"
              echo ""
              echo "Please check:"
              echo "1. Repository exists: https://github.com/edde746/plezy"
              echo "2. Repository has published releases (not drafts)"
              echo "3. GitHub API rate limits: https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting"
              exit 1
            fi
          fi

          echo "Final version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version already exists
        id: version_check
        run: |
          CURRENT_VERSION=$(grep 'version "' Casks/plezy.rb | sed 's/.*version "\(.*\)".*/\1/')
          LATEST_VERSION="${{ steps.latest_release.outputs.version }}"
          FORCE_UPDATE="${{ inputs.force }}"

          echo "Current version: $CURRENT_VERSION"
          echo "Latest version: $LATEST_VERSION"
          echo "Force update: $FORCE_UPDATE"

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ] && [ "$FORCE_UPDATE" != "true" ]; then
            echo "Version $LATEST_VERSION already exists and force is not enabled"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "Update needed: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Download release asset
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          echo "Downloading plezy-macos.dmg for version $VERSION"

          curl -L -o plezy-macos.dmg \
            "https://github.com/edde746/plezy/releases/download/$VERSION/plezy-macos.dmg"

          if [ ! -f plezy-macos.dmg ]; then
            echo "Failed to download release asset"
            exit 1
          fi

          ls -la plezy-macos.dmg

      - name: Calculate SHA256
        if: steps.version_check.outputs.needs_update == 'true'
        id: sha256
        run: |
          SHA256=$(shasum -a 256 plezy-macos.dmg | cut -d' ' -f1)
          echo "SHA256: $SHA256"
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Verify download contents
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          echo "Verifying DMG contents..."
          hdiutil attach plezy-macos.dmg -nobrowse -quiet

          # Find the mount point
          MOUNT_POINT=$(hdiutil info | grep -A1 "plezy-macos.dmg" | grep "/Volumes" | awk '{print $1}')
          if [ -z "$MOUNT_POINT" ]; then
            MOUNT_POINT="/Volumes/Plezy"
          fi

          echo "Mount point: $MOUNT_POINT"
          ls -la "$MOUNT_POINT"

          # Check if Plezy.app exists in the DMG
          if [ -d "$MOUNT_POINT/Plezy.app" ]; then
            echo "âœ… Plezy.app found in DMG"
          else
            echo "Warning: Plezy.app not found in expected location"
            echo "DMG contents:"
            ls -la "$MOUNT_POINT"
          fi

          hdiutil detach "$MOUNT_POINT" -quiet

      - name: Update cask file
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"

          cat > Casks/plezy.rb << EOF
          cask "plezy" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/edde746/plezy/releases/download/#{version}/plezy-macos.dmg"
            name "Plezy"
            desc "Modern Plex client for desktop and mobile"
            homepage "https://github.com/edde746/plezy"

            livecheck do
              url :url
              strategy :github_latest
            end

            auto_updates true

            app "Plezy.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/Plezy.app"],
                             sudo: false
            end

            uninstall quit: "com.edde746.plezy"

            zap trash: [
              "~/Library/Application Support/com.edde746.plezy",
              "~/Library/Caches/com.edde746.plezy",
              "~/Library/HTTPStorages/com.edde746.plezy",
              "~/Library/Preferences/com.edde746.plezy.plist",
              "~/Library/Saved Application State/com.edde746.plezy.savedState",
              "~/Library/WebKit/com.edde746.plezy",
            ]
          end
          EOF

          echo "Updated cask file:"
          cat Casks/plezy.rb

      - name: Validate cask
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          # Install Homebrew if not present
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
          fi

          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || true

          # Validate cask syntax
          echo "Validating cask syntax..."
          brew audit --strict --cask plezy || {
            echo "Cask validation failed, but continuing..."
          }

      - name: Test cask installation
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || true

          echo "Testing cask installation..."

          # Try to install the cask (dry run)
          brew install --cask plezy --dry-run || {
            echo "Dry run failed, but continuing with commit..."
          }

      - name: Commit and push changes
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Casks/plezy.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: update plezy to version $VERSION

          - Updated version to $VERSION
          - Updated SHA256 checksum
          - Release: https://github.com/edde746/plezy/releases/tag/$VERSION"

          git push

      - name: Create release summary
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"

          echo "## Plezy Updated to $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: ${{ steps.sha256.outputs.sha256 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: [View on GitHub](https://github.com/edde746/plezy/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "brew tap YOUR_USERNAME/plezy" >> $GITHUB_STEP_SUMMARY
          echo "brew install --cask plezy" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: No update needed
        if: steps.version_check.outputs.needs_update == 'false'
        run: |
          CURRENT_VERSION=$(grep 'version "' Casks/plezy.rb | sed 's/.*version "\(.*\)".*/\1/')
          echo "No update needed. Current version $CURRENT_VERSION is up to date."

          echo "## No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "Current version **$CURRENT_VERSION** is already the latest." >> $GITHUB_STEP_SUMMARY
