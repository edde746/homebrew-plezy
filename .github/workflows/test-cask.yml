name: Test Cask

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-cask:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Validate cask syntax
        run: |
          echo "Validating cask syntax..."
          brew audit --strict --cask plezy

      - name: Check cask style
        run: |
          echo "Checking cask style..."
          brew style plezy

      - name: Test cask installation (dry run)
        run: |
          echo "Testing cask installation (dry run)..."
          brew install --cask plezy --dry-run

      - name: Verify download URL
        run: |
          VERSION=$(grep 'version "' Casks/plezy.rb | sed 's/.*version "\(.*\)".*/\1/')
          URL="https://github.com/edde746/plezy/releases/download/$VERSION/plezy-macos.dmg"

          echo "Checking if download URL is accessible: $URL"

          # Check if URL returns 200 status
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

          if [ "$STATUS_CODE" = "200" ]; then
            echo "✅ Download URL is accessible"
          else
            echo "❌ Download URL returned status code: $STATUS_CODE"
            exit 1
          fi

      - name: Test SHA256 verification
        run: |
          VERSION=$(grep 'version "' Casks/plezy.rb | sed 's/.*version "\(.*\)".*/\1/')
          EXPECTED_SHA=$(grep 'sha256 "' Casks/plezy.rb | sed 's/.*sha256 "\(.*\)".*/\1/')
          URL="https://github.com/edde746/plezy/releases/download/$VERSION/plezy-macos.dmg"

          if [ "$EXPECTED_SHA" = "no_check" ]; then
            echo "⚠️ SHA256 is set to no_check - skipping verification"
            exit 0
          fi

          echo "Downloading file to verify SHA256..."
          curl -L -o plezy-macos.dmg "$URL"

          ACTUAL_SHA=$(shasum -a 256 plezy-macos.dmg | cut -d' ' -f1)

          echo "Expected SHA256: $EXPECTED_SHA"
          echo "Actual SHA256:   $ACTUAL_SHA"

          if [ "$EXPECTED_SHA" = "$ACTUAL_SHA" ]; then
            echo "✅ SHA256 verification passed"
          else
            echo "❌ SHA256 verification failed"
            exit 1
          fi

      - name: Verify app bundle structure
        run: |
          VERSION=$(grep 'version "' Casks/plezy.rb | sed 's/.*version "\(.*\)".*/\1/')
          URL="https://github.com/edde746/plezy/releases/download/$VERSION/plezy-macos.dmg"

          echo "Downloading and inspecting app bundle structure..."
          curl -L -o plezy-macos.dmg "$URL"

          echo "Mounting DMG..."
          hdiutil attach plezy-macos.dmg -nobrowse -quiet

          # Find the mount point
          MOUNT_POINT=$(hdiutil info | grep -A1 "plezy-macos.dmg" | grep "/Volumes" | awk '{print $1}')
          if [ -z "$MOUNT_POINT" ]; then
            MOUNT_POINT="/Volumes/Plezy"
          fi

          echo "Mount point: $MOUNT_POINT"
          echo "DMG contents:"
          ls -la "$MOUNT_POINT"

          APP_PATH="$MOUNT_POINT/Plezy.app"

          if [ -d "$APP_PATH" ]; then
            echo "✅ Plezy.app bundle found"

            # Check for Info.plist
            if [ -f "$APP_PATH/Contents/Info.plist" ]; then
              echo "✅ Info.plist found"

              # Extract bundle identifier
              BUNDLE_ID=$(plutil -p "$APP_PATH/Contents/Info.plist" | grep CFBundleIdentifier | sed 's/.*=> "\(.*\)".*/\1/')
              echo "Bundle ID: $BUNDLE_ID"

              # Extract app name
              APP_NAME=$(plutil -p "$APP_PATH/Contents/Info.plist" | grep CFBundleDisplayName | sed 's/.*=> "\(.*\)".*/\1/' || echo "Not found")
              echo "App Name: $APP_NAME"
            else
              echo "❌ Info.plist not found"
              hdiutil detach "$MOUNT_POINT" -quiet
              exit 1
            fi

            # Check for executable
            if [ -f "$APP_PATH/Contents/MacOS/plezy" ]; then
              echo "✅ Main executable found"
            else
              echo "⚠️ Main executable not found at expected location"
              echo "Contents of MacOS directory:"
              ls -la "$APP_PATH/Contents/MacOS/" || echo "MacOS directory not found"
            fi

          else
            echo "❌ Plezy.app bundle not found"
            echo "Available files/directories:"
            ls -la "$MOUNT_POINT"
            hdiutil detach "$MOUNT_POINT" -quiet
            exit 1
          fi

          hdiutil detach "$MOUNT_POINT" -quiet

  test-formula-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"

      - name: Install basic Ruby dependencies
        run: |
          gem install rubocop

      - name: Check Ruby syntax
        run: |
          echo "Checking Ruby syntax for cask files..."
          ruby -c Casks/plezy.rb
          echo "✅ Ruby syntax is valid"

      - name: Run RuboCop (if applicable)
        run: |
          echo "Running RuboCop style check..."
          rubocop Casks/plezy.rb --format simple || {
            echo "⚠️ Style issues found, but not failing the build"
            exit 0
          }
